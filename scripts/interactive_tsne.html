<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive t-SNE Visualization</title>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: black;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            color: white;
            font-weight: 500;
        }
        
        select {
            padding: 8px 12px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #777;
        }
        
        button {
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #555;
        }
        
        button:active {
            background-color: #666;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .year-display {
            font-size: 18px;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
            color: white;
        }
        
        .stats {
            text-align: center;
            margin-top: 10px;
            color: #999;
            font-size: 14px;
        }
        
        #plot {
            width: 100%;
            min-height: 800px;
            background-color: black !important;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #plot > .js-plotly-plot {
            background-color: black !important;
            width: 100% !important;
            height: 800px !important;
        }
        
        #plot .plotly .bg {
            fill: black !important;
        }
        
        #plot .plotly {
            position: relative !important;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-size: 16px;
            padding: 40px;
        }
        
        .error {
            text-align: center;
            color: #ff4444;
            font-size: 16px;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Interactive t-SNE Visualization</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="word-select">Select word:</label>
                <select id="word-select">
                    <option value="">-- Select a word --</option>
                </select>
                <button id="load-btn">Load Data</button>
            </div>
        </div>
        
        <div id="control-panel" style="display: none;">
            <div class="controls">
                <button id="show-all-btn">ðŸ“Š Show All Years</button>
                <span id="year-display" class="year-display"></span>
                <button id="prev-btn">â—€ Previous Year</button>
                <button id="next-btn">Next Year â–¶</button>
            </div>
            <div id="stats" class="stats"></div>
        </div>
        
        <div id="plot" style="background-color: black; color: white; font-size: 18px; padding: 20px; text-align: center; display: flex; align-items: center; justify-content: center; min-height: 800px;">
            Select a word and click "Load Data" to visualize
        </div>
        <div id="loading" class="loading" style="display: none;">Loading data...</div>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        // Global variables
        let allData = null;
        let currentYearIndex = 0;
        let showAll = true;
        let currentWord = '';
        
        // Load available words
        async function loadAvailableWords() {
            const wordSelect = document.getElementById('word-select');
            
            // Add your desired words here
            const commonWords = ['demokrasi'];
            const path = '../src/widid_results';
            
            for (const word of commonWords) {
                try {
                    const testPath = `${path}/${word}/tsne_${word}.csv`;
                    console.log(`Checking for data at: ${testPath}`);
                    
                    const response = await fetch(testPath);
                    if (response.ok) {
                        console.log(`âœ“ Found data for '${word}'`);
                        const option = document.createElement('option');
                        option.value = word;
                        option.textContent = word;
                        wordSelect.appendChild(option);
                    } else {
                        console.log(`âœ— No data found for '${word}'`);
                    }
                } catch (error) {
                    console.log(`Error checking ${word}:`, error.message);
                    continue;
                }
            }
            
            // If no words found, show message
            if (wordSelect.children.length === 1) {
                console.warn('No data files found. Make sure CSV files exist in ../src/widid_results/');
            }
        }
        
        // Load CSV data for a word
        async function loadData(word) {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            
            try {
                // Load from the correct path relative to scripts/ (when server is started from parent directory)
                const path = `../src/widid_results/${word}/tsne_${word}.csv`;
                console.log(`Attempting to load data from: ${path}`);
                
                const response = await fetch(path);
                
                if (!response || !response.ok) {
                    console.error('Failed to load from path:', path);
                    throw new Error(`Could not load data file. Make sure:\n1. You're running a web server from the parent directory (cd Semantic-Analysis-of-TBMM-Transcripts && python3 -m http.server 8000)\n2. The CSV file exists at: ${path}`);
                }
                
                const csvText = await response.text();
                console.log(`Successfully loaded ${csvText.length} characters of CSV data`);
                allData = parseCSV(csvText);
                console.log(`Parsed ${allData.length} data points`);
                currentWord = word;
                currentYearIndex = 0;
                showAll = true;
                
                loadingDiv.style.display = 'none';
                document.getElementById('control-panel').style.display = 'block';
                
                updatePlot();
                updateControls();
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                const errorMessage = error.message.replace(/\n/g, '<br>');
                errorDiv.innerHTML = `Error loading data: ${errorMessage}<br><br>Check browser console for details.`;
                console.error('Load data error:', error);
            }
        }
        
        // CSV parser that handles quoted strings
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            
            // Parse headers
            const headerLine = lines[0];
            const headers = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < headerLine.length; i++) {
                const char = headerLine[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    headers.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            headers.push(current.trim());
            
            // Parse data rows
            const data = [];
            for (let lineIdx = 1; lineIdx < lines.length; lineIdx++) {
                const line = lines[lineIdx];
                const values = [];
                current = '';
                inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                const row = {};
                headers.forEach((header, idx) => {
                    if (idx < values.length) {
                        row[header] = values[idx];
                    }
                });
                
                if (Object.keys(row).length > 0) {
                    data.push(row);
                }
            }
            
            return data;
        }
        
        // Get unique clusters
        function getUniqueClusters(data) {
            const clusters = new Set();
            data.forEach(row => clusters.add(parseInt(row.cluster_id)));
            return Array.from(clusters).sort((a, b) => a - b);
        }
        
        // Get unique years
        function getUniqueYears(data) {
            const years = new Set();
            data.forEach(row => years.add(parseInt(row.year)));
            return Array.from(years).sort((a, b) => a - b);
        }
        
        // Filter data by year
        function filterDataByYear(data, yearIndex, showAllMode) {
            if (showAllMode) {
                return data;
            }
            
            const years = getUniqueYears(data);
            if (yearIndex >= 0 && yearIndex < years.length) {
                return data.filter(row => parseInt(row.year) === years[yearIndex]);
            }
            
            return data;
        }
        
        // Create traces for plot
        function createTraces(filteredData) {
            const clusters = getUniqueClusters(filteredData);
            const traces = [];
            
            clusters.forEach((clusterId, idx) => {
                const clusterData = filteredData.filter(row => parseInt(row.cluster_id) === clusterId);
                
                if (clusterData.length > 0) {
                    const x = clusterData.map(row => parseFloat(row.tsne_x));
                    const y = clusterData.map(row => parseFloat(row.tsne_y));
                    const text = clusterData.map(row => 
                        `Cluster: ${row.cluster_id}<br>` +
                        `Term: ${row.term}, Year: ${row.year}<br>` +
                        `Context: ${row.context.substring(0, 150)}...`
                    );
                    
                    traces.push({
                        x: x,
                        y: y,
                        mode: 'markers',
                        type: 'scatter',
                        name: `Cluster ${clusterId}`,
                        text: text,
                        hovertemplate: '%{text}<extra></extra>',
                        marker: {
                            size: 8,
                            opacity: 0.7,
                            line: { width: 0.5, color: 'white' }
                        }
                    });
                }
            });
            
            return traces;
        }
        
        // Update the plot
        function updatePlot() {
            if (!allData) return;
            
            // Clear initial message and prepare for plotting
            const plotDiv = document.getElementById('plot');
            plotDiv.innerHTML = '';
            plotDiv.style.background = 'black';
            plotDiv.style.display = 'block';
            plotDiv.style.padding = '0';
            plotDiv.style.textAlign = 'left';
            
            const filteredData = filterDataByYear(allData, currentYearIndex, showAll);
            const traces = createTraces(filteredData);
            
            const years = getUniqueYears(allData);
            let titleSuffix = '';
            if (showAll) {
                titleSuffix = `All Years - ${allData.length} points`;
            } else {
                const currentYear = years[currentYearIndex];
                const yearData = allData.filter(row => parseInt(row.year) === currentYear);
                // Get term information for the current year
                const term = yearData.length > 0 ? parseInt(yearData[0].term) : '';
                titleSuffix = `d${term}y${currentYear} - ${yearData.length} points`;
            }
            
            const layout = {
                title: {
                    text: `t-SNE: '${currentWord}' - ${titleSuffix}`,
                    x: 0.5,
                    xanchor: 'center',
                    font: { family: 'Inter', size: 20, color: 'white' }
                },
                xaxis: {
                    title: {
                        text: 't-SNE Dimension 1',
                        font: { family: 'Inter', color: 'white' }
                    },
                    showgrid: true,
                    gridcolor: '#333',
                    fixedrange: true,
                    tickfont: { color: 'white', family: 'Inter' }
                },
                yaxis: {
                    title: {
                        text: 't-SNE Dimension 2',
                        font: { family: 'Inter', color: 'white' }
                    },
                    showgrid: true,
                    gridcolor: '#333',
                    fixedrange: true,
                    tickfont: { color: 'white', family: 'Inter' }
                },
                hovermode: 'closest',
                paper_bgcolor: '#000000',
                plot_bgcolor: '#000000',
                font: { family: 'Inter', color: 'white' },
                legend: {
                    bgcolor: 'rgba(0,0,0,0)',
                    bordercolor: 'rgba(255,255,255,0.2)',
                    borderwidth: 1,
                    font: { color: 'white', family: 'Inter' }
                },
                showlegend: true
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'zoom2d', 'lasso2d', 'select2d', 'autoScale2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: `tsne_${currentWord}`,
                    height: 800,
                    width: 1200,
                    scale: 2
                }
            };
            
            Plotly.newPlot('plot', traces, layout, config);
        }
        
        // Update control states
        function updateControls() {
            if (!allData) return;
            
            const years = getUniqueYears(allData);
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const yearDisplay = document.getElementById('year-display');
            const stats = document.getElementById('stats');
            const showAllBtn = document.getElementById('show-all-btn');
            
            // Update button states
            prevBtn.disabled = showAll || currentYearIndex === 0;
            nextBtn.disabled = showAll || currentYearIndex === years.length - 1;
            
            // Update show all button text
            if (showAll) {
                showAllBtn.textContent = 'Show Individual Years';
            } else {
                showAllBtn.textContent = 'ðŸ“Š Show All Years';
            }
            
            // Update year display
            if (showAll) {
                yearDisplay.textContent = 'All Years';
                stats.textContent = `Showing ${allData.length} points from all years`;
            } else {
                const currentYear = years[currentYearIndex];
                const yearData = allData.filter(row => parseInt(row.year) === currentYear);
                // Get term information for the current year
                const term = yearData.length > 0 ? parseInt(yearData[0].term) : '';
                yearDisplay.textContent = `d${term}y${currentYear}`;
                stats.textContent = `Showing ${yearData.length} points from d${term}y${currentYear}`;
            }
        }
        
        // Event listeners
        document.getElementById('load-btn').addEventListener('click', () => {
            const word = document.getElementById('word-select').value;
            console.log('Load button clicked, selected word:', word);
            if (word) {
                loadData(word);
            } else {
                alert('Please select a word first');
            }
        });
        
        document.getElementById('show-all-btn').addEventListener('click', () => {
            // Toggle between show all and show first year
            if (showAll) {
                // If showing all, switch to first year
                showAll = false;
                currentYearIndex = 0;
            } else {
                // If showing a specific year, switch to all years
                showAll = true;
            }
            updatePlot();
            updateControls();
        });
        
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentYearIndex > 0) {
                currentYearIndex--;
                showAll = false;
                updatePlot();
                updateControls();
            }
        });
        
        document.getElementById('next-btn').addEventListener('click', () => {
            const years = getUniqueYears(allData);
            if (currentYearIndex < years.length - 1) {
                currentYearIndex++;
                showAll = false;
                updatePlot();
                updateControls();
            }
        });
        
        // Initialize
        console.log('Initializing interactive t-SNE visualization...');
        console.log('Current location:', window.location.href);
        loadAvailableWords();
    </script>
</body>
</html>

